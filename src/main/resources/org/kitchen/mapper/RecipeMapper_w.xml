<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.rog//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.kitchen.mapper.RecipeMapper_w">

<resultMap id="recipe" type="org.kitchen.domain.RecipeVO">
   <result property="rno" column="r_num"/>
   <result property="title" column="title"/>
   <result property="thumbnail" column="thumbnail"/>
   <result property="regdate" column="regdate"/>
   <result property="updateDate" column="updatedate"/>
   <result property="cookingTime" column="cookingtime"/>
   <result property="difficulty" column="difficulty"/>
   <result property="userNo" column="u_num"/>
</resultMap>

<resultMap id="user" type="org.kitchen.domain.UserVO">
   <result property="userNo" column="u_num"/>
   <result property="userId" column="u_id"/>
   <result property="userPwd" column="u_pwd"/>
   <result property="email" column="email"/>
   <result property="emailAuth" column="email_auth"/>
   <result property="nickName" column="nickname"/>
   <result property="profilePhoto" column="u_photo"/>
   <result property="webUrl" column="u_url"/>
   <result property="bio" column="info"/>
   <result property="emailSub" column="email_news"/>
   <result property="privacy" column="u_privacy"/>
   <result property="status" column="status"  typeHandler="org.kitchen.handlers.CodeEnumTypeHandler" />
</resultMap>

<select id="getList" resultMap="recipe">
<![CDATA[select * from tbl_recipe where r_num>0]]>
</select>


<sql id="criteria">
	<trim prefix="(" suffix=") AND " prefixOverrides="OR">
 		<foreach item='type' collection="typeArr">
 			<trim prefix="OR">
 				<choose>
 					<when test="type == 'T'.toString()">
 						title like '%'||#{keyword}||'%'
					</when>
 					<when test="type == 'TW'.toString()">
 						title like '%'||#{keyword}||'%'
					</when>
				</choose>
			</trim>
		</foreach>
	</trim>
</sql>


<sql id="criteria_user">
	<trim prefix="(" suffix=") AND " prefixOverrides="OR">
 		<foreach item='type' collection="typeArr">
 			<trim prefix="OR">
 				<choose>
 					<when test="type == 'W'.toString()">
 						u_id like '%'||#{keyword}||'%'
 						or
 						nickname like '%'||#{keyword}||'%'
					</when>
 					<when test="type == 'TW'.toString()">
 						u_id like '%'||#{keyword}||'%'
 						or
 						nickname like '%'||{#keyword}||'%'
					</when>
				</choose>
			</trim>
		</foreach>
	</trim>
</sql>



<select id="getListWithPaging" resultMap="recipe">
<![CDATA[
select r_num, title, u_num, regdate
from
(
	select /*+INDEX_DESC(tbl_recipe)*/
		rownum rn, r_num ,title, u_num, regdate
	
 	from
 		tbl_recipe
 	where  
 ]]>
 	<include refid="criteria"></include>
	
	<![CDATA[ 	
	 	rownum<= #{pageNum} * #{amount}
	 	)
	where rn> (#{pageNum}-1) * #{amount}
	]]>
</select>


<select id="getUserList" resultMap="user">
<![CDATA[
select u_num, u_id, nickname
from
(
	select /*+INDEX_DESC(tbl_user)*/
		rownum rn, u_num, u_id, nickname
	from
		tbl_user
	where
]]>
	<include refid="criteria_user"></include> 
	<![CDATA[
		u_num>0 
	)
	where u_num>0
]]>
</select>
	
<sql id="criteria_tag">
	<trim prefix="(" suffix=") AND " prefixOverrides="OR">
 		<foreach item='type' collection="typeArr">
 			<trim prefix="OR">
 				<choose>
 					<when test="type == 'Tag'.toString()">
 						t_content like '%'||#{keyword,jdbcType=VARCHAR2}||'%';
 					</when>
				</choose>
			</trim>
		</foreach>
	</trim>
</sql>

<select id="getTagNum" resultType="Long">
select 
	t_num
from 
	tbl_tag
where 
	<if test="keyword!=null">
	 t_content like '%'||#{keyword,jdbcType=VARCHAR}||'%'
	</if>
</select>

<select id="getRnoByTagNum" resultType="Long">
select 
	r_num
from 
	tbl_recipetag
where
	 t_num	= #{tagNum}
</select>

<select id="getRecipeByRno" resultMap="recipe">
select 
 	r_num, title, u_num, regdate
from 
	tbl_recipe
where 
	r_num in 
	<foreach collection='list' index='index' item='rnoList' open='(' close=')' separator=','>
		#{rnoList}
	</foreach>
</select>


</mapper>
